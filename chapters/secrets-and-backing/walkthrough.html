<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>6.4. Walkthrough: Local &amp; Remote Secrets Management &#8212; Microsoft Azure  documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/fa/css/all.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/launchcode.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/site.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="6.5. Studio: Deploy CodingEventsAPI with KeyVault" href="studio.html" />
    <link rel="prev" title="6.3. Backing Services" href="backing-services.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body class="body-bc">

<div id="navbar" class="navbar navbar-default navbar-fixed-top">
   <div class="container">
     <div class="navbar-header">
       <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
       <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
         <span class="icon-bar"></span>
         <span class="icon-bar"></span>
         <span class="icon-bar"></span>
       </button>
       <a class="navbar-brand" href="../../index.html"><span><img src="../../_static/lc-ed-logo.png" alt="LaunchCode logo"></span>
       </a>
       <span class="navbar-text navbar-version pull-left"><b></b></span>
     </div>

       <div class="collapse navbar-collapse nav-collapse">
         <ul class="nav navbar-nav">
           
           
             
           
           
           
           
           
         </ul>

         
           
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
    <label for="q" class="searchLabel">Search</label>
    <input type="text" name="q" class="form-control" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
         
       </div>
   </div>
 </div>

<ol class="breadcrumb container">
    <li><a href="../../index.html">Contents</a></li>
    <li><a href="index.html">6. Secrets Management &amp; Backing Services</a></li>
    <li class="active">6.4. Walkthrough: Local &amp; Remote Secrets Management</li>
</ol>



<div class="container">
  <div class="row">
    <div class="col-md-10 col-md-offset-1 content ">

    
  <div class="section" id="walkthrough-local-remote-secrets-management">
<h1>6.4. Walkthrough: Local &amp; Remote Secrets Management<a class="headerlink" href="#walkthrough-local-remote-secrets-management" title="Permalink to this headline">¶</a></h1>
<p>In our walkthrough today, we will be working with a sample application to learn about secrets management. We will use the <code class="docutils literal notranslate"><span class="pre">dotnet</span> <span class="pre">user-secrets</span></code> to manage the secrets on our local machine. When we deploy the application we will be using Azure Key Vault as a remote secrets manager.</p>
<div class="section" id="explore-concepts">
<h2>6.4.1. Explore Concepts<a class="headerlink" href="#explore-concepts" title="Permalink to this headline">¶</a></h2>
<div class="section" id="get-the-source-code">
<h3>6.4.1.1. Get the Source Code<a class="headerlink" href="#get-the-source-code" title="Permalink to this headline">¶</a></h3>
<p>To begin this walkthrough, we will each need to fork the project on GitHub. We are each going to have to set up our own unique Key Vault that must be configured in our application settings. First fork <a class="reference external" href="https://github.com/LaunchCodeEducation/dotnet-user-secrets-az-keyvault" target="_blank">this repository<i class="fas fa-external-link-alt" aria-hidden="true"></i></a> to your own GitHub account.</p>
<p>After you fork this project, clone your new repository to your local machine using the command below. Be sure to replace <code class="docutils literal notranslate"><span class="pre">&lt;YOURUSERNAME&gt;</span></code> with your own GitHub username.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/&lt;YOURUSERNAME&gt;/dotnet-user-secrets-az-keyvault
</pre></div>
</div>
</div>
<div class="section" id="local-how-it-works">
<h3>6.4.1.2. Local: How it Works<a class="headerlink" href="#local-how-it-works" title="Permalink to this headline">¶</a></h3>
<p>We already know what secrets are and that they are managed by secrets managers, but how do they work?</p>
<p>Locally, in our development environment, we will be using <code class="docutils literal notranslate"><span class="pre">dotnet</span> <span class="pre">user-secrets</span></code> as our secrets manager.</p>
<div class="section" id="dotnet-user-secrets-local-secrets">
<h4>6.4.1.2.1. Dotnet User-Secrets (Local Secrets)<a class="headerlink" href="#dotnet-user-secrets-local-secrets" title="Permalink to this headline">¶</a></h4>
<p>Our local secrets manager is <code class="docutils literal notranslate"><span class="pre">dotnet</span> <span class="pre">user-secrets</span></code>. As you can see from by the command, this is a tool built into the <code class="docutils literal notranslate"><span class="pre">dotnet</span></code> CLI.</p>
<p>Using the <code class="docutils literal notranslate"><span class="pre">dotnet</span> <span class="pre">user-secrets</span></code> command we can create a secrets store. Each secrets store is unique to a .NET project. A secrets store is a directory on your local machine that the user-secrets manager creates to store your secrets. The secrets store directory is located separately from your project directory, which means there is no chance it will be committed to Git. Once a secrets store has been initialized in a project, you can add and manage secrets using the <code class="docutils literal notranslate"><span class="pre">dotnet</span> <span class="pre">user-secrets</span></code> tool. Secrets are saved as key-value pairs within the secrets store.</p>
<p>There are two commands we will be using:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">init</span></code>: initializes a new secrets store for the project</li>
<li><code class="docutils literal notranslate"><span class="pre">set</span></code>:  creates, or updates, a secret within the secrets store</li>
</ul>
<p>To work with a secrets store you should first navigate to the project directory.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Initialize a secrets store</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> dotnet-user-secrets-az-keyvault
dotnet user-secrets init --id walkthrough-secrets
dotnet user-secrets <span class="nb">set</span> Name &lt;yourname&gt;
</pre></div>
</div>
</div>
<p>Once you have initialized your project’s secrets store you can create a new secret with <code class="docutils literal notranslate"><span class="pre">set</span></code>. The <code class="docutils literal notranslate"><span class="pre">set</span></code> command takes two arguments: the first is the key, and the second is the value. For our project, we will need a secret with a key of <code class="docutils literal notranslate"><span class="pre">Name</span></code> and a value of your first name.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># make sure to do this within your project directory</span>
dotnet user-secrets <span class="nb">set</span> Name &lt;yourname&gt;
</pre></div>
</div>
</div>
<div class="section" id="application-user-secrets-integration">
<h4>6.4.1.2.2. Application User-Secrets Integration<a class="headerlink" href="#application-user-secrets-integration" title="Permalink to this headline">¶</a></h4>
<p>You may be wondering how our application will know where to find the secrets store. We must provide our application with the ID of our secrets store for it to be recognized. When we used <code class="docutils literal notranslate"><span class="pre">dotnet</span> <span class="pre">user-secrets</span> <span class="pre">init</span></code>, the ID we provided was registered in our <code class="docutils literal notranslate"><span class="pre">api-user-secrets.csproj</span></code> file automatically.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">api-user-secrets.csproj</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-csharp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="p">=</span><span class="s">&quot;1.0&quot;</span> <span class="n">encoding</span><span class="p">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">?&gt;</span>
<span class="p">&lt;</span><span class="n">Project</span> <span class="n">Sdk</span><span class="p">=</span><span class="s">&quot;Microsoft.NET.Sdk.Web&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">PropertyGroup</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="n">TargetFramework</span><span class="p">&gt;</span><span class="n">netcoreapp3</span><span class="p">.</span><span class="m">1</span><span class="p">&lt;/</span><span class="n">TargetFramework</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="n">RootNamespace</span><span class="p">&gt;</span><span class="n">api_user_secrets</span><span class="p">&lt;/</span><span class="n">RootNamespace</span><span class="p">&gt;</span>
<span class="hll">   <span class="p">&lt;</span><span class="n">UserSecretsId</span><span class="p">&gt;</span><span class="n">walkthrough</span><span class="p">-</span><span class="n">secrets</span><span class="p">&lt;/</span><span class="n">UserSecretsId</span><span class="p">&gt;</span>
</span><span class="p">&lt;/</span><span class="n">PropertyGroup</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">ItemGroup</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="n">PackageReference</span> <span class="n">Include</span><span class="p">=</span><span class="s">&quot;Microsoft.Azure.KeyVault&quot;</span> <span class="n">Version</span><span class="p">=</span><span class="s">&quot;3.0.5&quot;</span> <span class="p">/&gt;</span>
   <span class="p">&lt;</span><span class="n">PackageReference</span> <span class="n">Include</span><span class="p">=</span><span class="s">&quot;Microsoft.Extensions.Configuration.AzureKeyVault&quot;</span> <span class="n">Version</span><span class="p">=</span><span class="s">&quot;3.1.2&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="n">ItemGroup</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="n">Project</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div>
</div>
<p>It is this entry in the <code class="docutils literal notranslate"><span class="pre">.csproj</span></code> file that is responsible for integrating our application and our local secrets manager.</p>
</div>
<div class="section" id="accessing-the-secrets-store">
<h4>6.4.1.2.3. Accessing the Secrets Store<a class="headerlink" href="#accessing-the-secrets-store" title="Permalink to this headline">¶</a></h4>
<p>Now that our application can access the secrets store, how can our code access specific secrets? Let’s take a look at our <code class="docutils literal notranslate"><span class="pre">Startup.cs</span></code> file to find out.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Startup.cs</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-csharp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Builder</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Hosting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.HttpsPolicy</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Configuration</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Hosting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Logging</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">api_user_secrets</span>
<span class="p">{</span>
   <span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
   <span class="p">{</span>
<span class="hll">      <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">secret</span><span class="p">;</span>
</span>      <span class="k">public</span> <span class="nf">Startup</span><span class="p">(</span><span class="n">IConfiguration</span> <span class="n">configuration</span><span class="p">)</span>
      <span class="p">{</span>
            <span class="n">Configuration</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">public</span> <span class="n">IConfiguration</span> <span class="n">Configuration</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

      <span class="c1">// This method gets called by the runtime. Use this method to add services to the container.</span>
      <span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
      <span class="p">{</span>
            <span class="c1">//accessing the Environment variables that .NET has loaded for us in Configuration</span>
<span class="hll">            <span class="n">secret</span> <span class="p">=</span> <span class="n">Configuration</span><span class="p">[</span><span class="s">&quot;Name&quot;</span><span class="p">];</span>
</span>            <span class="n">services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IConfiguration</span><span class="p">&gt;(</span><span class="n">Configuration</span><span class="p">);</span>
            <span class="n">services</span><span class="p">.</span><span class="n">AddControllers</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="c1">// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span>
      <span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">,</span> <span class="n">IWebHostEnvironment</span> <span class="n">env</span><span class="p">)</span>
      <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">IsDevelopment</span><span class="p">())</span>
            <span class="p">{</span>
               <span class="n">app</span><span class="p">.</span><span class="n">UseDeveloperExceptionPage</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="n">app</span><span class="p">.</span><span class="n">UseHttpsRedirection</span><span class="p">();</span>

            <span class="n">app</span><span class="p">.</span><span class="n">UseRouting</span><span class="p">();</span>

            <span class="n">app</span><span class="p">.</span><span class="n">UseAuthorization</span><span class="p">();</span>

            <span class="n">app</span><span class="p">.</span><span class="n">UseEndpoints</span><span class="p">(</span><span class="n">endpoints</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
               <span class="n">endpoints</span><span class="p">.</span><span class="n">MapControllers</span><span class="p">();</span>
            <span class="p">});</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>On line 18 we are declaring a new public static field. The <code class="docutils literal notranslate"><span class="pre">public</span></code> modifier means it’s available to classes outside of the <code class="docutils literal notranslate"><span class="pre">Startup</span></code> class. The <code class="docutils literal notranslate"><span class="pre">static</span></code> modifier means an object doesn’t have to be instantiated to access this field. So this <code class="docutils literal notranslate"><span class="pre">Startup.secret</span></code> field will be available to any of our files.</p>
<p>When a secrets store is registered in a project, its secrets will be automatically loaded into the <code class="docutils literal notranslate"><span class="pre">Configuration</span></code> object. We can access a specific secret by its key. Line 30 assigns the value of the secret <code class="docutils literal notranslate"><span class="pre">Name</span></code> to the static field <code class="docutils literal notranslate"><span class="pre">Startup.secret</span></code>.</p>
<p>This static field allows any of the other files in our project to access the secret’s value.</p>
</div>
<div class="section" id="using-the-secret">
<h4>6.4.1.2.4. Using the Secret<a class="headerlink" href="#using-the-secret" title="Permalink to this headline">¶</a></h4>
<p>Where are we actually using our secret? Check out our lone controller file <code class="docutils literal notranslate"><span class="pre">SecretController.cs</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">SecretController.cs</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-csharp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Logging</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">api_user_secrets.Controllers</span>
<span class="p">{</span>
<span class="na">   [ApiController]</span>
<span class="na">   [Route(&quot;[controller]</span><span class="s">&quot;)]</span>
   <span class="k">public</span> <span class="k">class</span> <span class="nc">SecretController</span> <span class="p">:</span> <span class="n">ControllerBase</span>
   <span class="p">{</span>

      <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">SecretController</span><span class="p">&gt;</span> <span class="n">_logger</span><span class="p">;</span>

      <span class="k">public</span> <span class="nf">SecretController</span><span class="p">(</span><span class="n">ILogger</span><span class="p">&lt;</span><span class="n">SecretController</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span>
      <span class="p">{</span>
            <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
      <span class="p">}</span>

<span class="na">      [HttpGet]</span>
      <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">Get</span><span class="p">()</span>
      <span class="p">{</span>
<span class="hll">            <span class="k">return</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="n">Startup</span><span class="p">.</span><span class="n">secret</span> <span class="p">};</span>
</span>      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>In our controller file there is one route for HTTP GET request <code class="docutils literal notranslate"><span class="pre">/secret</span></code>. This handler returns the value of the secret stored in the <code class="docutils literal notranslate"><span class="pre">Startup.secret</span></code> static field.</p>
<p>In this case, our secret isn’t very sensitive. However, this process is representative of how you can use secrets in a project. Typically your name wouldn’t be considered sensitive data, but many things <em>are</em> sensitive, such as a database connection string that includes a username and password.</p>
</div>
</div>
<div class="section" id="remote-how-it-works">
<h3>6.4.1.3. Remote: How it Works<a class="headerlink" href="#remote-how-it-works" title="Permalink to this headline">¶</a></h3>
<p>It would be a pain to configure <code class="docutils literal notranslate"><span class="pre">dotnet</span> <span class="pre">user-secrets</span></code> for every VM that hosts our project. Microsoft provides us with a more scalable solution for managing secrets called Azure Key Vault.</p>
<p>Azure Key Vault is a cloud-based secrets manager which can be accessed remotely, unlike <code class="docutils literal notranslate"><span class="pre">dotnet</span> <span class="pre">user-secrets</span></code>. Instead of configuring each VM to use their own local secrets manager, we can setup one global secrets manager that any authorized VM can access.</p>
<p>Before we can do this, we need to configure our application to know when to use a local secrets manager and when to use a remote secrets manager.</p>
<div class="section" id="application-environments">
<h4>6.4.1.3.1. Application Environments<a class="headerlink" href="#application-environments" title="Permalink to this headline">¶</a></h4>
<p>We want to use our local secrets manager when we are developing our project, but want to use our remote secrets manager when we deploy our application. There are two different environments our application runs in: development (local) and production (remote). We will need to introduce some logic into our application that will allow it to use our local secrets manager when it detects a development environment, while using a remote secrets manager when it detects a production environment.</p>
<p>When you run an application with <code class="docutils literal notranslate"><span class="pre">dotnet</span> <span class="pre">run</span></code> .NET considers it a development environment. When you use <code class="docutils literal notranslate"><span class="pre">dotnet</span> <span class="pre">publish</span></code> and then run the build artifact it .NET considers that a production environment.</p>
<p>The logic for this needs to occur at the entry point of .NET applications, <code class="docutils literal notranslate"><span class="pre">Program.cs</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">Program.cs</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-csharp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// if not in Production environment (dotnet run) don&#39;t setup KeyVault and use the default Secret Storage managed through dotnet user-secrets</span>
<span class="hll"><span class="k">if</span> <span class="p">(!</span><span class="n">context</span><span class="p">.</span><span class="n">HostingEnvironment</span><span class="p">.</span><span class="n">IsProduction</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span>
</span>
<span class="c1">// if in Production environment (dotnet publish) setup KeyVault -- pull the KeyVault name from appsettings.json</span>

<span class="kt">var</span> <span class="n">builtConfig</span> <span class="p">=</span> <span class="n">config</span><span class="p">.</span><span class="n">Build</span><span class="p">();</span>

<span class="kt">var</span> <span class="n">azureServiceTokenProvider</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AzureServiceTokenProvider</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">keyVaultClient</span> <span class="p">=</span> <span class="k">new</span> <span class="n">KeyVaultClient</span><span class="p">(</span>
   <span class="k">new</span> <span class="n">KeyVaultClient</span><span class="p">.</span><span class="n">AuthenticationCallback</span><span class="p">(</span>
      <span class="n">azureServiceTokenProvider</span><span class="p">.</span><span class="n">KeyVaultTokenCallback</span>
   <span class="p">)</span>
<span class="p">);</span>

<span class="n">config</span><span class="p">.</span><span class="n">AddAzureKeyVault</span><span class="p">(</span>
   <span class="s">&quot;https://{builtConfig[&quot;</span><span class="n">KeyVaultName</span><span class="s">&quot;]}.vault.azure.net/&quot;</span><span class="p">,</span>
   <span class="n">keyVaultClient</span><span class="p">,</span>
   <span class="k">new</span> <span class="nf">DefaultKeyVaultSecretManager</span><span class="p">()</span>
<span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Line 24 is a conditional statement. There are some comments explaining the different logical paths, but essentially the first path is that in a development environment we load the local secrets manager (<code class="docutils literal notranslate"><span class="pre">dotnet</span> <span class="pre">user-secrets</span></code>) by default. In a production environment, we configure and connect to the remote secrets manager (Azure Key Vault).</p>
</div>
<div class="section" id="application-key-vault-integration">
<h4>6.4.1.3.2. Application Key Vault Integration<a class="headerlink" href="#application-key-vault-integration" title="Permalink to this headline">¶</a></h4>
<p>How does our application know which Key Vault to use?</p>
<p>You may have noticed in <code class="docutils literal notranslate"><span class="pre">Program.cs</span></code> we are trying to access <code class="docutils literal notranslate"><span class="pre">KeyVaultName</span></code> from the <code class="docutils literal notranslate"><span class="pre">builtConfig</span></code> object on line 36. This object loads the key-value pairs from the <code class="docutils literal notranslate"><span class="pre">appsettings.json</span></code> file.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">appsettings.json</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-csharp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="s">&quot;Logging&quot;</span><span class="p">:</span> <span class="p">{</span>
   <span class="s">&quot;LogLevel&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">&quot;Default&quot;</span><span class="p">:</span> <span class="s">&quot;Information&quot;</span><span class="p">,</span>
      <span class="s">&quot;Microsoft&quot;</span><span class="p">:</span> <span class="s">&quot;Warning&quot;</span><span class="p">,</span>
      <span class="s">&quot;Microsoft.Hosting.Lifetime&quot;</span><span class="p">:</span> <span class="s">&quot;Information&quot;</span>
   <span class="p">}</span>
<span class="p">},</span>
<span class="s">&quot;AllowedHosts&quot;</span><span class="p">:</span> <span class="s">&quot;*&quot;</span><span class="p">,</span>
<span class="hll"><span class="s">&quot;KeyVaultName&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
</span><span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Currently, there is an empty key-value pair with the key <code class="docutils literal notranslate"><span class="pre">KeyVaultName</span></code>. After we setup an Azure Key Vault we will have to provide its name as the value to this entry.</p>
</div>
</div>
<div class="section" id="bringing-it-together">
<h3>6.4.1.4. Bringing it Together<a class="headerlink" href="#bringing-it-together" title="Permalink to this headline">¶</a></h3>
<p>Let’s run our project locally to see how it works.</p>
<p>From your project directory (<code class="docutils literal notranslate"><span class="pre">/dotnet-user-secrets-az-keyvault</span></code>) run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>dotnet run
</pre></div>
</div>
<img alt="../../_images/dotnet-run-local.png" src="../../_images/dotnet-run-local.png" />
<p>Then navigate to <a class="reference external" href="https://localhost:5001/secret" target="_blank">https://localhost:5001/secret<i class="fas fa-external-link-alt" aria-hidden="true"></i></a>.</p>
<p>You should see a line that says <code class="docutils literal notranslate"><span class="pre">&lt;yourname&gt;</span></code>. This is the value of the secret (<code class="docutils literal notranslate"><span class="pre">Name</span></code>) we set earlier.</p>
<img alt="../../_images/paul-user-secret.png" src="../../_images/paul-user-secret.png" />
<p>Now let’s set up our remote secrets manager, the Azure Key Vault.</p>
</div>
</div>
<div class="section" id="create-resource-group">
<h2>6.4.2. Create Resource Group<a class="headerlink" href="#create-resource-group" title="Permalink to this headline">¶</a></h2>
<p>Before we can configure a Key Vault we will need to provision a new resource group.</p>
<p>You should use the following pattern for your resource group Name: <code class="docutils literal notranslate"><span class="pre">yourname-rg-secrets</span></code>.</p>
<p>Below are images that will remind you how to create a resource group. Refer to previous walkthroughs if you need additional help.</p>
<img alt="../../_images/provision-rg1.png" src="../../_images/provision-rg1.png" />
<img alt="../../_images/provision-rg2.png" src="../../_images/provision-rg2.png" />
<img alt="../../_images/provision-rg3.png" src="../../_images/provision-rg3.png" />
<p>After creating your resource group, move on to the next step.</p>
</div>
<div class="section" id="provision-a-vm">
<h2>6.4.3. Provision a VM<a class="headerlink" href="#provision-a-vm" title="Permalink to this headline">¶</a></h2>
<p>We will need a VM to deploy our application. So let’s create a new one now.</p>
<img alt="../../_images/provision-vm1.png" src="../../_images/provision-vm1.png" />
<img alt="../../_images/provision-vm2.png" src="../../_images/provision-vm2.png" />
<p>Make sure to select the correct image, change the <em>Authentication Type</em> to <em>Password</em>, and create a username <code class="docutils literal notranslate"><span class="pre">student</span></code> and password <code class="docutils literal notranslate"><span class="pre">LaunchCode-&#64;zure1</span></code>.</p>
<img alt="../../_images/provision-vm3.png" src="../../_images/provision-vm3.png" />
<p>As one additional step to previous VM provisioning, we will need to change the <em>System assigned managed identity</em> to <em>On</em>. You will find this option in the <em>Management</em> section of the VM creation wizard.</p>
<img alt="../../_images/provision-vm-system-identity.png" src="../../_images/provision-vm-system-identity.png" />
<p>Enabling <em>System assigned managed identity</em> allows the VM to search for other Azure resources, auch as the Key Vault we will be setting up soon!</p>
<img alt="../../_images/provision-vm4.png" src="../../_images/provision-vm4.png" />
<div class="admonition-warning admonition">
<p class="first admonition-title"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i>Warning</p>
<p>If you didn’t change the <em>Authentication Type</em> to <em>Password</em> and create a User name <code class="docutils literal notranslate"><span class="pre">student</span></code>, you will run into issues later when trying to perform RunCommands.</p>
<p class="last">If you didn’t change <em>System assigned managed identity</em> from <em>Off</em> to <em>On</em> you will have issues when your VM attempts to access the Key Vault.</p>
</div>
<p>After provisioning your VM, move on to the next step.</p>
</div>
<div class="section" id="create-key-vault">
<h2>6.4.4. Create Key Vault<a class="headerlink" href="#create-key-vault" title="Permalink to this headline">¶</a></h2>
<p>We need to create our Key Vault and add a secret to it.</p>
<p>Search for the Key Vault blade.</p>
<img alt="../../_images/keyvault-search.png" src="../../_images/keyvault-search.png" />
<p>Looking at the main page, we will want to add a new Key Vault. Click the <em>Add</em> button.</p>
<img alt="../../_images/keyvault-add.png" src="../../_images/keyvault-add.png" />
<p>This will take you to the Key Vault creation wizard.</p>
<p>Fill out the form with your resource group name <code class="docutils literal notranslate"><span class="pre">yourname-rg-secrets</span></code> and your Key Vault name. We recommend using a pattern like <code class="docutils literal notranslate"><span class="pre">yourname-kv-secrets</span></code>.</p>
<div class="admonition-note admonition">
<p class="first admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p class="last">Key Vault names must be globally unique. This means you may have to try a few different Key Vault names to get it to work.</p>
</div>
<img alt="../../_images/keyvault-form.png" src="../../_images/keyvault-form.png" />
<p>After completing the form, click <em>Create</em>.</p>
<img alt="../../_images/keyvault-create.png" src="../../_images/keyvault-create.png" />
<p>We can now return to our code now that we have our Key Vault name.</p>
</div>
<div class="section" id="update-code-to-access-key-vault">
<h2>6.4.5. Update Code to Access Key Vault<a class="headerlink" href="#update-code-to-access-key-vault" title="Permalink to this headline">¶</a></h2>
<p>Open <code class="docutils literal notranslate"><span class="pre">appsettings.json</span></code> with your editor of choice and paste in the name of your new Key Vault.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">appsettings.json</span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-csharp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="s">&quot;Logging&quot;</span><span class="p">:</span> <span class="p">{</span>
   <span class="s">&quot;LogLevel&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">&quot;Default&quot;</span><span class="p">:</span> <span class="s">&quot;Information&quot;</span><span class="p">,</span>
      <span class="s">&quot;Microsoft&quot;</span><span class="p">:</span> <span class="s">&quot;Warning&quot;</span><span class="p">,</span>
      <span class="s">&quot;Microsoft.Hosting.Lifetime&quot;</span><span class="p">:</span> <span class="s">&quot;Information&quot;</span>
   <span class="p">}</span>
<span class="p">},</span>
<span class="s">&quot;AllowedHosts&quot;</span><span class="p">:</span> <span class="s">&quot;*&quot;</span><span class="p">,</span>
<span class="hll"><span class="s">&quot;KeyVaultName&quot;</span><span class="p">:</span> <span class="s">&quot;paul-kv-secrets&quot;</span>
</span><span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Make sure to commit and push these changes up to your repository. We will be cloning this repository into our VM and we need it to have the change we just made so it can access our Key Vault.</p>
</div>
<div class="section" id="grant-vm-access-to-key-vault">
<h2>6.4.6. Grant VM Access to Key Vault<a class="headerlink" href="#grant-vm-access-to-key-vault" title="Permalink to this headline">¶</a></h2>
<p>By default, the Key Vault blocks all requests for its contents. We will need to grant our VM access to our Key Vault secrets. We will use the VM Identity we assigned earlier to register its access to the Key Vault.</p>
<p>Select your Key Vault.</p>
<img alt="../../_images/grant-access1.png" src="../../_images/grant-access1.png" />
<p>From here we will need to select <code class="docutils literal notranslate"><span class="pre">Access</span> <span class="pre">Policies</span></code> under the Settings header.</p>
<img alt="../../_images/grant-access2.png" src="../../_images/grant-access2.png" />
<p>From here we will need to click <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">Access</span> <span class="pre">Policy</span></code> to grant our VM permission to access this Key Vault.</p>
<img alt="../../_images/grant-access3.png" src="../../_images/grant-access3.png" />
<p>This pulls up a new form which we will fill out by selecting the template <em>Secret Management</em>, which will auto-fill out the next boxes. Then we will need to click on <em>None Selected</em> next to <em>Service Principal</em>. This registers our VM Identity as an authorized Service Principal.</p>
<img alt="../../_images/grant-access4.png" src="../../_images/grant-access4.png" />
<p>You can enter the name of your VM in the search box.</p>
<img alt="../../_images/grant-access5.png" src="../../_images/grant-access5.png" />
<img alt="../../_images/grant-access6.png" src="../../_images/grant-access6.png" />
<p>Now to complete the creation of this access policy we just need to hit the <em>Add</em> button. This takes us back to the Access Policy screen and we can see the new policy that was created for our VM.</p>
<img alt="../../_images/grant-access7.png" src="../../_images/grant-access7.png" />
<p>We have granted our VM access to the secrets contained within our Key Vault.</p>
</div>
<div class="section" id="add-secret-to-key-vault">
<h2>6.4.7. Add Secret to Key Vault<a class="headerlink" href="#add-secret-to-key-vault" title="Permalink to this headline">¶</a></h2>
<p>To add secrets to our Key Vault we need to navigate to the <em>Secrets</em> section under <em>Settings</em>.</p>
<img alt="../../_images/keyvault-secrets.png" src="../../_images/keyvault-secrets.png" />
<p>Then click the <em>Generate/Import</em> button.</p>
<img alt="../../_images/keyvault-generate-import.png" src="../../_images/keyvault-generate-import.png" />
<p>Then fill out the form manually with your key/value pair.</p>
<ul class="simple">
<li>Key: <code class="docutils literal notranslate"><span class="pre">Name</span></code></li>
<li>Value: <code class="docutils literal notranslate"><span class="pre">yourname</span></code></li>
</ul>
<img alt="../../_images/keyvault-form-filled-out.png" src="../../_images/keyvault-form-filled-out.png" />
<p>Click the <em>Create</em> button to add this secret to your Key Vault.</p>
<img alt="../../_images/keyvault-secret-final.png" src="../../_images/keyvault-secret-final.png" />
<p>Our Key Vault is now set up and we can move on to the deployment.</p>
</div>
<div class="section" id="install-dependencies-to-vm">
<h2>6.4.8. Install Dependencies to VM<a class="headerlink" href="#install-dependencies-to-vm" title="Permalink to this headline">¶</a></h2>
<p>In the Azure portal, navigate to your VM and enter the <em>RunCommand</em> console. As a reminder, this can be found under <em>Operations</em>.</p>
<div class="admonition">
<p class="first admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p class="last">Remember that using <em>RunCommand</em> will take some time, so after you hit <em>Run</em> give it a few minutes. This first <em>RunCommand</em> will take the longest, since it downloads and installs the .NET SDK.</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget https://packages.microsoft.com/config/ubuntu/18.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
sudo dpkg -i packages-microsoft-prod.deb
sudo apt-get update<span class="p">;</span> <span class="se">\</span>
  sudo apt-get install -y apt-transport-https <span class="o">&amp;&amp;</span> <span class="se">\</span>
  sudo apt-get update <span class="o">&amp;&amp;</span> <span class="se">\</span>
  sudo apt-get install -y dotnet-sdk-3.1
<span class="nb">export</span> <span class="nv">DOTNET_CLI_HOME</span><span class="o">=</span>/home/student
<span class="nb">export</span> <span class="nv">HOME</span><span class="o">=</span>/home/student
dotnet --version
</pre></div>
</div>
<p>You will know that the SDK installed correctly if you see the version number of the .NET installation. In the following picture, the version is highlighted and is <code class="docutils literal notranslate"><span class="pre">3.1.301</span></code>.</p>
<img alt="../../_images/install-dotnet.png" src="../../_images/install-dotnet.png" />
</div>
<div class="section" id="deliver-the-code">
<h2>6.4.9. Deliver the Code<a class="headerlink" href="#deliver-the-code" title="Permalink to this headline">¶</a></h2>
<p>Clone your project to your Virtual Machine with the following bash commands in the <em>RunCommand</em> console.</p>
<div class="admonition">
<p class="first admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p class="last">If you forked the repository, your GitHub URL will look something like this <code class="docutils literal notranslate"><span class="pre">https://github.com/&lt;YOURUSERNAME&gt;/dotnet-user-secrets-az-keyvault</span></code>. Double check that you reference the URL correctly or it won’t work in the Azure <em>RunCommand</em>.</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">DOTNET_CLI_HOME</span><span class="o">=</span>/home/student
<span class="nb">export</span> <span class="nv">HOME</span><span class="o">=</span>/home/student
<span class="nb">cd</span> /home/student
git clone https://github.com/&lt;YOURUSERNAME&gt;/dotnet-user-secrets-az-keyvault
ls /home/student
</pre></div>
</div>
<p>You should see a new folder named <code class="docutils literal notranslate"><span class="pre">dotnet-user-secrets-az-keyvault</span></code>.</p>
<img alt="../../_images/vm-clone.png" src="../../_images/vm-clone.png" />
</div>
<div class="section" id="publish">
<h2>6.4.10. Publish<a class="headerlink" href="#publish" title="Permalink to this headline">¶</a></h2>
<p>To publish, we will need to be in the project directory and run <code class="docutils literal notranslate"><span class="pre">dotnet</span> <span class="pre">publish</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">DOTNET_CLI_HOME</span><span class="o">=</span>/home/student
<span class="nb">export</span> <span class="nv">HOME</span><span class="o">=</span>/home/student
<span class="nb">cd</span> /home/student/dotnet-user-secrets-az-keyvault
dotnet publish -c Release -r linux-x64 -p:PublishSingleFile<span class="o">=</span><span class="nb">true</span>
</pre></div>
</div>
<img alt="../../_images/dotnet-publish.png" src="../../_images/dotnet-publish.png" />
</div>
<div class="section" id="deploy">
<h2>6.4.11. Deploy<a class="headerlink" href="#deploy" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">DOTNET_CLI_HOME</span><span class="o">=</span>/home/student
<span class="nb">export</span> <span class="nv">HOME</span><span class="o">=</span>/home/student
<span class="nb">cd</span> /home/student/dotnet-user-secrets-az-keyvault
<span class="nv">ASPNETCORE_URLS</span><span class="o">=</span><span class="s2">&quot;http://*:80&quot;</span> ./bin/Release/netcoreapp3.1/linux-x64/publish/api-user-secrets
</pre></div>
</div>
<p>This deploy step will look like it’s stuck if it’s successful because the process attaches itself to the running application, as shown in the picture below.</p>
<img alt="../../_images/dotnet-deploy.png" src="../../_images/dotnet-deploy.png" />
</div>
<div class="section" id="vm-security-groups">
<h2>6.4.12. VM Security Groups<a class="headerlink" href="#vm-security-groups" title="Permalink to this headline">¶</a></h2>
<p>As a final step, we need to open our <em>Network Security Groups</em>.</p>
<p>From the VM select <em>Networking</em> under the <em>Settings</em> section.</p>
<img alt="../../_images/vm-nsg1.png" src="../../_images/vm-nsg1.png" />
<p>Add new inbound and outbound rules for port 80.</p>
<img alt="../../_images/vm-nsg2.png" src="../../_images/vm-nsg2.png" />
<img alt="../../_images/vm-nsg3.png" src="../../_images/vm-nsg3.png" />
</div>
<div class="section" id="test-your-deployment">
<h2>6.4.13. Test Your Deployment<a class="headerlink" href="#test-your-deployment" title="Permalink to this headline">¶</a></h2>
<p>Navigate to <code class="docutils literal notranslate"><span class="pre">http://&lt;YOURVMIP&gt;/secret</span></code> where you can find your hosted application.</p>
<p>Your running app should look similar to the following picture.</p>
<img alt="../../_images/final-app.png" src="../../_images/final-app.png" />
</div>
</div>



    
    <nav aria-label="Next and Previous Pages">
      <ul class="pager">
        
        <li class="previous"><a href="backing-services.html"><span aria-hidden="true">&larr;</span> 6.3. Backing Services</a></li>
        
        
        <li class="next"><a href="studio.html">6.5. Studio: Deploy <code class="docutils literal notranslate"><span class="pre">CodingEventsAPI</span></code> with KeyVault <span aria-hidden="true">&rarr;</span></a></li>
        
      </ul>
    </nav>
    
    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../../_sources/chapters/secrets-and-backing/walkthrough.rst.txt"
     rel="nofollow">Page Source</a>
</div>
      
    </p>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>