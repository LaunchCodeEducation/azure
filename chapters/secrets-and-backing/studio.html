<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>6.5. Studio: Deploy CodingEventsAPI with KeyVault &#8212; Microsoft Azure  documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/fa/css/all.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/launchcode.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/site.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="7. Introduction to Authentication &amp; Authorization with Azure AD B2C" href="../intro-oauth-with-aadb2c/index.html" />
    <link rel="prev" title="6.4. Walkthrough: Local &amp; Remote Secrets Management" href="walkthrough.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body class="body-bc">

<div id="navbar" class="navbar navbar-default navbar-fixed-top">
   <div class="container">
     <div class="navbar-header">
       <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
       <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
         <span class="icon-bar"></span>
         <span class="icon-bar"></span>
         <span class="icon-bar"></span>
       </button>
       <a class="navbar-brand" href="../../index.html"><span><img src="../../_static/lc-ed-logo.png" alt="LaunchCode logo"></span>
       </a>
       <span class="navbar-text navbar-version pull-left"><b></b></span>
     </div>

       <div class="collapse navbar-collapse nav-collapse">
         <ul class="nav navbar-nav">
           
           
             
           
           
           
           
           
         </ul>

         
           
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
    <label for="q" class="searchLabel">Search</label>
    <input type="text" name="q" class="form-control" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
         
       </div>
   </div>
 </div>

<ol class="breadcrumb container">
    <li><a href="../../index.html">Contents</a></li>
    <li><a href="index.html">6. Secrets Management &amp; Backing Services</a></li>
    <li class="active">6.5. Studio: Deploy <code class="docutils literal notranslate"><span class="pre">CodingEventsAPI</span></code> with KeyVault</li>
</ol>



<div class="container">
  <div class="row">
    <div class="col-md-10 col-md-offset-1 content ">

    
  <div class="section" id="studio-deploy-codingeventsapi-with-keyvault">
<h1>6.5. Studio: Deploy <code class="docutils literal notranslate"><span class="pre">CodingEventsAPI</span></code> with KeyVault<a class="headerlink" href="#studio-deploy-codingeventsapi-with-keyvault" title="Permalink to this headline">¶</a></h1>
<p>In our studio today, we will be deploying the <code class="docutils literal notranslate"><span class="pre">CodingEventsAPI</span></code> to an Ubuntu VM. As part of the deployment we will provision an Azure Key Vault to manage the database connection string of an embedded MySQL database server.</p>
<p>In this studio, you will be given a partially completed Bash script that will configure your VM. You will be responsible for applying what you have learned to complete the automation.</p>
<div class="admonition-note admonition">
<p class="first admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p class="last">These lessons are focused on practicing operations and <em>not</em> on learning development. For this reason, we will be using <a class="reference external" href="https://github.com/LaunchCodeEducation/coding-events-api/tree/2-mysql-solution" target="_blank">the solution branch<i class="fas fa-external-link-alt" aria-hidden="true"></i></a> <code class="docutils literal notranslate"><span class="pre">2-mysql-solution</span></code> that includes the development-side changes. Feel free to look over the code base but remember to focus your time on the deployment.</p>
</div>
<div class="section" id="checklist">
<h2>6.5.1. Checklist<a class="headerlink" href="#checklist" title="Permalink to this headline">¶</a></h2>
<p>Let’s start by considering the steps needed to deploy this application. Note that this list is an overview, for the specific details refer to your notes and previous articles.</p>
<p>On the Azure side you will need to:</p>
<ul class="simple">
<li>Provision a resource group</li>
<li>Provision a virtual machine</li>
<li>Provision a Key Vault</li>
<li>Create a Key Vault secret</li>
<li>Grant Key Vault access to the VM</li>
</ul>
<p>To complete the configuration script you will need to write the commands to:</p>
<ul class="simple">
<li>Download the dependencies to VM</li>
<li>Clone the source code to VM</li>
<li>Publish the source code</li>
<li>Deploy the application</li>
</ul>
<div class="section" id="gotchas">
<h3>6.5.1.1. Gotchas<a class="headerlink" href="#gotchas" title="Permalink to this headline">¶</a></h3>
<p>There are steps in this process that can be easily over-looked.</p>
<p>As you work on your deployment keep in mind:</p>
<ul class="simple">
<li>Your VM should have the <code class="docutils literal notranslate"><span class="pre">Authentication</span> <span class="pre">Type</span></code> of <code class="docutils literal notranslate"><span class="pre">Password</span></code></li>
<li>Your VM must have a username of <code class="docutils literal notranslate"><span class="pre">student</span></code> and therefore a home directory of <code class="docutils literal notranslate"><span class="pre">/home/student</span></code></li>
<li>Your VM property <em>System assigned managed identity</em> must be set to <em>On</em></li>
<li>Your Key Vault must be configured to grant access to your VM</li>
<li>The source code you publish must be updated with your Key Vault name</li>
<li>Your deployed application will not be reachable until the VM network security groups have been opened for port <code class="docutils literal notranslate"><span class="pre">80</span></code> (HTTP traffic)</li>
</ul>
</div>
</div>
<div class="section" id="planning">
<h2>6.5.2. Planning<a class="headerlink" href="#planning" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Provision resources</li>
<li>Configure Key Vault</li>
<li>Update code</li>
<li>Complete configuration script</li>
</ol>
<p>Once you have completed these steps, you can execute the configuration script in the <em>RunCommand</em> console to complete the deployment.</p>
</div>
<div class="section" id="limited-guidance">
<h2>6.5.3. Limited Guidance<a class="headerlink" href="#limited-guidance" title="Permalink to this headline">¶</a></h2>
<p>The following sections will guide you on specifics and steps you may not have seen yet. Before starting the studio, take a moment to read them over and come up with a plan for when and how you will use them.</p>
<div class="section" id="provision-resources">
<h3>6.5.3.1. Provision Resources<a class="headerlink" href="#provision-resources" title="Permalink to this headline">¶</a></h3>
<p>We will need to create a resource group that will contain a virtual machine and a Key Vault.</p>
<p>We recommend the following naming patterns:</p>
<ul class="simple">
<li>Resource group: <code class="docutils literal notranslate"><span class="pre">lc-&lt;yourname&gt;-&lt;mmyy&gt;-secrets-rg</span></code></li>
<li>Virtual machine: <code class="docutils literal notranslate"><span class="pre">lc-&lt;yourname&gt;-&lt;mmyy&gt;-secrets-vm</span></code></li>
<li>Key Vault: <code class="docutils literal notranslate"><span class="pre">lc-&lt;yourname&gt;-&lt;mmyy&gt;-secrets-kv</span></code></li>
</ul>
<p>Replace &lt;mmyy&gt; with the digits for the month and year for example: March of 2020 would be <code class="docutils literal notranslate"><span class="pre">0320</span></code>.</p>
<div class="admonition-note admonition">
<p class="first admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p class="last">Azure Key Vault names must be globally unique. If you have to adjust your Key Vault name make sure to keep track of it as you will need to include it in your source code later.</p>
</div>
</div>
<div class="section" id="configure-key-vault">
<h3>6.5.3.2. Configure Key Vault<a class="headerlink" href="#configure-key-vault" title="Permalink to this headline">¶</a></h3>
<p>To configure your Key Vault, you will need to create a new secret with the following values:</p>
<ul class="simple">
<li>Name: <code class="docutils literal notranslate"><span class="pre">ConnectionStrings--Default</span></code></li>
<li>Value: <code class="docutils literal notranslate"><span class="pre">server=localhost;port=3306;database=coding_events;user=coding_events;password=launchcode</span></code></li>
</ul>
<p>Refer to the previous walkthrough to review how to grant a VM access to a Key Vault.</p>
</div>
<div class="section" id="update-code">
<h3>6.5.3.3. Update Code<a class="headerlink" href="#update-code" title="Permalink to this headline">¶</a></h3>
<p>You will need to do update your <code class="docutils literal notranslate"><span class="pre">appsettings.json</span></code> file to include the name of your Key Vault.</p>
<p>In your forked <cite>CodingEventsAPI</cite> repository directory, switch to the <code class="docutils literal notranslate"><span class="pre">2-mysql-solution</span></code> branch. Make the Key Vault name change in the <code class="docutils literal notranslate"><span class="pre">appsettings.json</span></code> file then commit and push your code back to your GitHub repository.</p>
<p>The line you will be looking for is:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">appsettings.json</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="s">&quot;KeyVaultName&quot;</span><span class="p">:</span> <span class="s">&quot;&lt;your-keyvault-name&gt;&quot;</span>
</pre></div>
</div>
</div>
<div class="admonition-warning admonition">
<p class="first admonition-title"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i>Warning</p>
<p class="last">If you do <em>not</em> update your code and push it back to your GitHub repository your deployment <em>will</em> fail.</p>
</div>
</div>
</div>
<div class="section" id="developing-the-deployment-script">
<h2>6.5.4. Developing the Deployment Script<a class="headerlink" href="#developing-the-deployment-script" title="Permalink to this headline">¶</a></h2>
<p>We have been using the <em>RunCommand</em> tool to run Bash scripts on our virtual machine. This tool is handy, but not the most pleasant experience because of its inherent processing delay. Instead of running multiple commands through the <em>RunCommand</em> let’s put together a single script that will do everything necessary to deploy our application.</p>
<div class="admonition-tip admonition">
<p class="first admonition-title"><i class="fas fa-lightbulb" aria-hidden="true"></i>Tip</p>
<p class="last">After learning the specific steps of a deployment process it’s almost always a good idea to put those steps together in a script. The more practice you get with operations, the more scripting deployments will become second nature. Review previous walkthroughs and studios to combine all of the steps, from each article, into one script.</p>
</div>
<p>We will provide you with a starter script that installs and sets up the embedded MySQL database server. However, you will be responsible for piecing the rest of the script together yourself.</p>
<p>Take notice of the <code class="docutils literal notranslate"><span class="pre">TODO</span></code> tasks in the script below. After you have completed the script, you will need to run it in the <em>RunCommand</em> section of your VM. Then your application will be deployed all in one step!</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># set HOME environment variable</span>
<span class="nb">export</span> <span class="nv">HOME</span><span class="o">=</span>/home/student

<span class="c1"># update apt-get repositories</span>
apt-get update

<span class="c1">### MySQL section START ###</span>

<span class="c1"># download the apt-get repository source package for MySQL</span>
wget https://dev.mysql.com/get/mysql-apt-config_0.8.15-1_all.deb

<span class="c1"># register the repository package with apt-get</span>
dpkg -i mysql-apt-config_0.8.15-1_all.deb

<span class="c1"># update apt-get now that it has the new repo</span>
apt-get update

<span class="c1"># set environment variables that are necessary for MySQL installation</span>
debconf-set-selections <span class="o">&lt;&lt;&lt;</span> <span class="s2">&quot;mysql-community-server mysql-community-server/root-pass password lc-password&quot;</span>
debconf-set-selections <span class="o">&lt;&lt;&lt;</span> <span class="s2">&quot;mysql-community-server mysql-community-server/re-root-pass password lc-password&quot;</span>

<span class="c1"># install MySQL in a noninteractive way since the environment variables set the necessary information for setup</span>
sudo <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive apt-get -y install mysql-server

<span class="c1"># create a setup.sql file which will create our database, our user, and grant our user privileges to the database</span>
cat &gt;&gt; setup.sql <span class="s">&lt;&lt; EOF</span>
<span class="s">CREATE DATABASE coding_events;</span>
<span class="s">CREATE USER &#39;coding_events&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;launchcode&#39;;</span>
<span class="s">GRANT ALL PRIVILEGES ON coding_events.* TO &#39;coding_events&#39;@&#39;localhost&#39;;</span>
<span class="s">FLUSH PRIVILEGES;</span>
<span class="s">EOF</span>

<span class="c1"># using the mysql CLI to run the setup.sql file as the root user in the mysql database</span>
mysql -u root --password<span class="o">=</span>lc-password mysql &lt; setup.sql

<span class="c1">### MySQL section END ###</span>

<span class="c1"># TODO: download and install the dotnet SDK</span>

<span class="c1"># set DOTNET_CLI_HOME environment variable</span>
<span class="nb">export</span> <span class="nv">DOTNET_CLI_HOME</span><span class="o">=</span><span class="nv">$HOME</span>

<span class="c1"># TODO: clone your forked repo</span>


<span class="c1"># TODO: change into the repo directory</span>


<span class="c1"># TODO: checkout the correct branch (2-mysql-solution)</span>


<span class="c1"># TODO: change into CodingEventsAPI/</span>


<span class="c1"># TODO: publish source code</span>


<span class="c1"># deploy application by running the published executable</span>
<span class="c1"># this assumes your CWD is /home/student/coding-events-api/CodingEventsAPI</span>
<span class="nv">ASPNETCORE_URLS</span><span class="o">=</span><span class="s2">&quot;http://*:80&quot;</span> ./bin/Release/netcoreapp3.1/linux-x64/publish/CodingEventsAPI
</pre></div>
</div>
</div>
<div class="section" id="connect-to-the-api">
<h2>6.5.5. Connect to the API<a class="headerlink" href="#connect-to-the-api" title="Permalink to this headline">¶</a></h2>
<p>Once you complete and execute your <em>RunCommand</em> script, your application will be deployed. That is, assuming there were no errors with your script or application. If you had errors in your <em>RunCommand</em> section, double-check the steps, and review the “Gotchas” section above.</p>
<p>You can access the deployed API in your browser at <code class="docutils literal notranslate"><span class="pre">http://&lt;YOUR-VM-IP&gt;</span></code>.</p>
<p>You will know you have succeeded when you can view the Swagger homepage from your browser:</p>
<img alt="../../_images/secrets-studio-final.png" src="../../_images/secrets-studio-final.png" />
</div>
</div>



    
    <nav aria-label="Next and Previous Pages">
      <ul class="pager">
        
        <li class="previous"><a href="walkthrough.html"><span aria-hidden="true">&larr;</span> 6.4. Walkthrough: Local &amp; Remote Secrets Management</a></li>
        
        
        <li class="next"><a href="../intro-oauth-with-aadb2c/index.html">7. Introduction to Authentication &amp; Authorization with Azure AD B2C <span aria-hidden="true">&rarr;</span></a></li>
        
      </ul>
    </nav>
    
    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../../_sources/chapters/secrets-and-backing/studio.rst.txt"
     rel="nofollow">Page Source</a>
</div>
      
    </p>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>