<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>9.9. Studio: Automated Deployment of the Coding Events API &#8212; Microsoft Azure  documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/fa/css/all.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/launchcode.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/site.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="10. Windows Server &amp; IIS" href="../ws-iis/index.html" />
    <link rel="prev" title="9.8. Making API Requests Using Invoke-RestMethod" href="cmdlet-invoke-restmethod.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body class="body-bc">

<div id="navbar" class="navbar navbar-default navbar-fixed-top">
   <div class="container">
     <div class="navbar-header">
       <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
       <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
         <span class="icon-bar"></span>
         <span class="icon-bar"></span>
         <span class="icon-bar"></span>
       </button>
       <a class="navbar-brand" href="../../index.html"><span><img src="../../_static/lc-ed-logo.png" alt="LaunchCode logo"></span>
       </a>
       <span class="navbar-text navbar-version pull-left"><b></b></span>
     </div>

       <div class="collapse navbar-collapse nav-collapse">
         <ul class="nav navbar-nav">
           
           
             
           
           
           
           
           
         </ul>

         
           
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
    <label for="q" class="searchLabel">Search</label>
    <input type="text" name="q" class="form-control" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
         
       </div>
   </div>
 </div>

<ol class="breadcrumb container">
    <li><a href="../../index.html">Contents</a></li>
    <li><a href="index.html">9. Introduction to PowerShell</a></li>
    <li class="active">9.9. Studio: Automated Deployment of the Coding Events API</li>
</ol>



<div class="container">
  <div class="row">
    <div class="col-md-10 col-md-offset-1 content ">

    
  <div class="section" id="studio-automated-deployment-of-the-coding-events-api">
<h1>9.9. Studio: Automated Deployment of the Coding Events API<a class="headerlink" href="#studio-automated-deployment-of-the-coding-events-api" title="Permalink to this headline">¶</a></h1>
<p>In this studio we will be using <em>PowerShell to script a complete deployment of the Coding Events API to a Linux VM</em>.</p>
<p>This PowerShell script will provision and configure all of the Azure resources we will need for the deployment. The script will combine all the steps from the Azure CLI chapter into one easily runnable deploy script.</p>
<p>You will be writing the PowerShell script, however the provisioned VM will require three Bash configuration scripts. <a class="reference external" href="https://github.com/LaunchCodeEducation/powershell-az-cli-scripting-deployment" target="_blank">The VM Bash configuration scripts<i class="fas fa-external-link-alt" aria-hidden="true"></i></a> will be provided for you, but it would be in your best interest to read over them to make sense of what they are doing.</p>
<p>This will be one of the most challenging studios you have worked on. However, at the end of this studio, you will gain invaluable practical experience writing real scripts and utilizing the <em>power</em> of PowerShell. To that end, consider a methodical approach to completing it:</p>
<ol class="arabic simple">
<li>The manual steps you need to perform to provision Azure resources</li>
<li>The Azure CLI groups, sub-groups, commands, and arguments you will need to use to accomplish them</li>
<li>The PowerShell syntax you will need to coordinate the steps</li>
<li><em>Break the problem down into discrete tasks that you can test in isolation</em></li>
</ol>
<p>While the first two steps should now be familiar to you, the final two points are the most critical. Before you start using any of the commands, make sure to write smaller scripts to test out how to:</p>
<ul class="simple">
<li>Capture command outputs as variables</li>
<li>Access properties of variable objects</li>
<li>Use variable and command substitution</li>
</ul>
<p>These are all techniques you have worked with in previous walkthroughs and studios that you can review if necessary.</p>
<div class="section" id="your-tasks">
<h2>9.9.1. Your Tasks<a class="headerlink" href="#your-tasks" title="Permalink to this headline">¶</a></h2>
<div class="section" id="fork-clone">
<h3>9.9.1.1. Fork &amp; Clone<a class="headerlink" href="#fork-clone" title="Permalink to this headline">¶</a></h3>
<p>Fork and clone the <a class="reference external" href="https://github.com/LaunchCodeEducation/powershell-az-cli-scripting-deployment" target="_blank">powershell-az-cli-scripting-deployment<i class="fas fa-external-link-alt" aria-hidden="true"></i></a> repository.</p>
</div>
<div class="section" id="complete-the-provision-resources-script">
<h3>9.9.1.2. Complete the Provision Resources Script<a class="headerlink" href="#complete-the-provision-resources-script" title="Permalink to this headline">¶</a></h3>
<p>Update the <code class="docutils literal notranslate"><span class="pre">provisionResources.ps1</span></code> script so that it accomplishes the following:</p>
<ol class="arabic simple">
<li>Set variables</li>
<li>Provision RG</li>
<li>Provision VM</li>
<li>Capture the VM <code class="docutils literal notranslate"><span class="pre">systemAssignedIdentity</span></code></li>
<li>Open vm port 443</li>
<li>Provision a Key Vault</li>
<li>Create the Key Vault secret (database connection string)</li>
<li>Set the Key Vault’s access-policy (using the vm <code class="docutils literal notranslate"><span class="pre">systemAssignedIdentity</span></code>)</li>
<li>Send 3 bash scripts to the VM using az vm run-command invoke (<code class="docutils literal notranslate"><span class="pre">configure-vm.sh</span></code>, <code class="docutils literal notranslate"><span class="pre">configure-ssl.sh</span></code>, <code class="docutils literal notranslate"><span class="pre">deliver-deploy.sh</span></code>)</li>
<li>Print VM public IP address to STDOUT or save it as a file</li>
</ol>
<p>We will provide you with steps 6 and 9, which have a high likelihood being written incorrectly and causing an error.</p>
<div class="admonition-tip admonition">
<p class="first admonition-title"><i class="fas fa-lightbulb" aria-hidden="true"></i>Tip</p>
<p class="last">The Bash script <code class="docutils literal notranslate"><span class="pre">provision-resources.sh</span></code> you saw earlier is very similar to this script, due to the cross-platform nature of the Azure CLI. However, the shell-specific syntax will be the bulk of your work in writing a PowerShell variant.</p>
</div>
</div>
<div class="section" id="update-source-code">
<h3>9.9.1.3. Update Source Code<a class="headerlink" href="#update-source-code" title="Permalink to this headline">¶</a></h3>
<p>After completing the script, you will need to update the <code class="docutils literal notranslate"><span class="pre">KeyVaultName</span></code> in your <code class="docutils literal notranslate"><span class="pre">appsettings.json</span></code> using the name that you set in your <code class="docutils literal notranslate"><span class="pre">provisionResources.ps1</span></code> script. In step 6 of the script it was automatically set to <code class="docutils literal notranslate"><span class="pre">&lt;name&gt;-lc0820-ps-kv</span></code>.</p>
</div>
<div class="section" id="update-the-deliver-deploy-script">
<h3>9.9.1.4. Update the Deliver &amp; Deploy Script<a class="headerlink" href="#update-the-deliver-deploy-script" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">deliver-deploy.sh</span></code> script will require you to set your GitHub username and the branch of your Coding Events API that includes the updated <code class="docutils literal notranslate"><span class="pre">appsettings.json</span></code>. These are the variables at the top of the script:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">github_username=</span></code> (your username)</li>
<li><code class="docutils literal notranslate"><span class="pre">solution_branch=</span></code> (<code class="docutils literal notranslate"><span class="pre">3-aadb2c</span></code>)</li>
</ul>
</div>
<div class="section" id="run-the-script">
<h3>9.9.1.5. Run the Script<a class="headerlink" href="#run-the-script" title="Permalink to this headline">¶</a></h3>
<p>Finally, run the script and confirm the deployment by navigating to the public IP address that it prints out!</p>
</div>
</div>
<div class="section" id="submitting-your-work">
<h2>9.9.2. Submitting Your Work<a class="headerlink" href="#submitting-your-work" title="Permalink to this headline">¶</a></h2>
<p>After you have finished and executed your deploy script you will be able to access your running application using HTTPS at the public IP address of your VM.</p>
<p>Share this link along with your <code class="docutils literal notranslate"><span class="pre">powershell-az-cli-scripting-deployment</span></code> repo link with your TA so they can review your work.</p>
</div>
<div class="section" id="limited-guidance">
<h2>9.9.3. Limited Guidance<a class="headerlink" href="#limited-guidance" title="Permalink to this headline">¶</a></h2>
<div class="section" id="running-custom-powershell-scripts">
<h3>9.9.3.1. Running Custom PowerShell Scripts<a class="headerlink" href="#running-custom-powershell-scripts" title="Permalink to this headline">¶</a></h3>
<p>Recall that Windows will not let you just run a PowerShell script, you must first set the <code class="docutils literal notranslate"><span class="pre">ExecutionPolicy</span></code> before you can run any custom PowerShell scripts.</p>
</div>
<div class="section" id="azure-cli-response-examples">
<h3>9.9.3.2. Azure CLI Response Examples<a class="headerlink" href="#azure-cli-response-examples" title="Permalink to this headline">¶</a></h3>
<p>In the cloned repository you will find a folder called <code class="docutils literal notranslate"><span class="pre">exampleResources</span></code>. This folder contains three JSON files with the output of each Azure CLI command.</p>
<p>You can use these example resources to practice working with these outputs as PowerShell objects. They can be loaded from the file and converted to <code class="docutils literal notranslate"><span class="pre">PSCustomObjects</span></code> (<em>exactly what the commands will output</em>) using <code class="docutils literal notranslate"><span class="pre">Get-Content</span></code> and <code class="docutils literal notranslate"><span class="pre">ConvertFrom-Json</span></code>.</p>
<p>For example, you can examine the resource group name with:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">Get-Content</span> <span class="p">./</span><span class="n">resourceGroup</span><span class="p">.</span><span class="n">json</span> <span class="p">|</span> <span class="nb">ConvertFrom-Json</span><span class="p">).</span><span class="n">name</span>
</pre></div>
</div>
<p>Recall that your Key Vault will need the VM’s <code class="docutils literal notranslate"><span class="pre">systemAssignedIdentity</span></code> to properly set an access policy from the Azure CLI. See if you can access this property with PowerShell and <code class="docutils literal notranslate"><span class="pre">virtualMachine.json</span></code>. Then consider and practice accessing the other properties you will need using:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">virtualMachine.json</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">resourceGroup.json</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">keyVault.json</span></code></li>
</ul>
<p>Here is a general example of how to load and access a property. Be mindful of the syntax needed to access nested properties, or those that exist within an array field:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">load JSON file into a PS variable</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="p">&gt;</span> <span class="nv">$virtualMachine</span> <span class="p">=</span> <span class="nb">Get-Content</span> <span class="n">virtualMachine</span><span class="p">.</span><span class="n">json</span> <span class="p">|</span> <span class="nb">ConvertFrom-Json</span>

<span class="p">&gt;</span> <span class="nv">$virtualMachine</span><span class="p">.</span><span class="n">someProperty</span>
</pre></div>
</div>
</div>
<div class="admonition-fun-fact admonition">
<p class="first admonition-title"><i class="fas fa-rocket" aria-hidden="true"></i>Fun Fact</p>
<p>These files were created using a simple PowerShell pipeline. For example, the <code class="docutils literal notranslate"><span class="pre">virtualMachine.json</span></code> file was created like this:</p>
<div class="literal-block-wrapper last docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">capture AZ CLI output in JSON file</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="p">&gt;</span> <span class="n">az</span> <span class="n">vm</span> <span class="n">create</span> <span class="n">-n</span> <span class="p">....</span> <span class="p">|</span> <span class="nb">Set-Content</span> <span class="n">virtualMachine</span><span class="p">.</span><span class="n">json</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="az-cli-help">
<h3>9.9.3.3. AZ CLI Help<a class="headerlink" href="#az-cli-help" title="Permalink to this headline">¶</a></h3>
<p>As we saw in the Azure CLI walkthrough, you will want to explore and plan out your commands before turning them into a script. As a reminder, you can get help for any AZ CLI command, or sub-command with <code class="docutils literal notranslate"><span class="pre">-h</span></code> or the longhand <code class="docutils literal notranslate"><span class="pre">--help</span></code>:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="p">&gt;</span> <span class="n">az</span> <span class="n">vm</span> <span class="n">create</span> <span class="n">-h</span>
</pre></div>
</div>
</div>
<div class="section" id="capturing-az-cli-output-in-a-variable">
<h3>9.9.3.4. Capturing AZ CLI Output in a Variable<a class="headerlink" href="#capturing-az-cli-output-in-a-variable" title="Permalink to this headline">¶</a></h3>
<p>Similar to how the example <code class="docutils literal notranslate"><span class="pre">.json</span></code> files were created, you can capture the output in a variable:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">capture AZ CLI output in variable</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="p">&gt;</span> <span class="nv">$someVariable</span> <span class="p">=</span> <span class="n">az</span> <span class="n">vm</span> <span class="n">create</span> <span class="n">-n</span> <span class="p">.....</span>

<span class="p">&gt;</span> <span class="nv">$someVariable</span><span class="p">.</span><span class="n">someProperty</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="fresh-start">
<h3>9.9.3.5. Fresh Start<a class="headerlink" href="#fresh-start" title="Permalink to this headline">¶</a></h3>
<p>If you think you’ve messed something up throughout this deployment, you can easily destroy the entire resource group using the AZ CLI:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="p">&gt;</span> <span class="nv">$rgName</span> <span class="p">=</span> <span class="s2">&quot;&lt;your-rg-name&gt;&quot;</span>
<span class="p">&gt;</span> <span class="n">az</span> <span class="nb">group </span><span class="n">delete</span> <span class="n">-n</span> <span class="s2">&quot;$rgName&quot;</span>
</pre></div>
</div>
<p>This command takes a couple of minutes to run because it first has to delete each of the resources inside of the resource group. However, this handy command allows you to cleanup easily, or start over if you’ve made a mistake!</p>
</div>
</div>
</div>



    
    <nav aria-label="Next and Previous Pages">
      <ul class="pager">
        
        <li class="previous"><a href="cmdlet-invoke-restmethod.html"><span aria-hidden="true">&larr;</span> 9.8. Making API Requests Using Invoke-RestMethod</a></li>
        
        
        <li class="next"><a href="../ws-iis/index.html">10. Windows Server &amp; IIS <span aria-hidden="true">&rarr;</span></a></li>
        
      </ul>
    </nav>
    
    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../../_sources/chapters/powershell-intro/studio_powershell-scripted-deployment.rst.txt"
     rel="nofollow">Page Source</a>
</div>
      
    </p>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>